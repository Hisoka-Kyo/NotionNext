<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸»é¡µ - çŸ¥è¯†æ˜Ÿçƒæˆå‘˜ä¸“äº«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 90%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 600;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .auth-section {
            margin: 30px 0;
        }

        .auth-btn {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        .status-message {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.6;
        }

        .status-loading {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .status-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .hidden {
            display: none;
        }

        /* ç”¨æˆ·ä¿¡æ¯å±•ç¤ºæ ·å¼ */
        .user-info-panel {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: left;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .user-info-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #555;
            min-width: 100px;
        }

        .info-value {
            color: #333;
            word-break: break-all;
            text-align: right;
            max-width: 60%;
        }

        .btn-small {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            margin: 5px;
        }

        .btn-small:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 30px 20px;
            }
            
            .info-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .info-value {
                max-width: 100%;
                text-align: left;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- è®¤è¯é¡µé¢ -->
    <div id="authPage" class="container">
        <div class="logo">ğŸŒŸ</div>
        <h1>ä¸ªäººä¸»é¡µ</h1>
        <p class="subtitle">çŸ¥è¯†æ˜Ÿçƒæˆå‘˜èº«ä»½éªŒè¯</p>
        
        <div id="statusMessage" class="status-message hidden"></div>
        
        <div class="auth-section">
            <p style="color: #666; margin-bottom: 20px;">
                è¯·è¿›è¡ŒçŸ¥è¯†æ˜Ÿçƒæˆå‘˜èº«ä»½éªŒè¯
            </p>
            
            <button id="authBtn" class="auth-btn" onclick="startAuth()">
                ğŸ” å¼€å§‹èº«ä»½éªŒè¯
            </button>
            
            <p style="color: #999; font-size: 12px; margin-top: 15px;">
                ç‚¹å‡»åå°†è·³è½¬åˆ°çŸ¥è¯†æ˜Ÿçƒè¿›è¡Œèº«ä»½éªŒè¯
            </p>
        </div>

        <!-- ç”¨æˆ·ä¿¡æ¯å±•ç¤ºé¢æ¿ -->
        <div id="userInfoPanel" class="user-info-panel hidden">
            <div class="user-info-title">âœ… éªŒè¯æˆåŠŸï¼è·å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯ï¼š</div>
            <div id="userInfoContent"></div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-small" onclick="continueToHomepage()">ğŸ“± è¿›å…¥ä¸ªäººä¸»é¡µ</button>
                <button class="btn-small btn-danger" onclick="restartAuth()">ğŸ”„ é‡æ–°éªŒè¯</button>
            </div>
        </div>
    </div>

    <!-- ä¸ªäººä¸»é¡µ -->
    <div id="mainContent" class="container hidden">
        <div class="logo">ğŸ‘¤</div>
        <h1 id="userName">çŸ¥è¯†æ˜Ÿçƒæˆå‘˜</h1>
        <p id="userRole" class="subtitle"></p>
        
        <div class="user-info-panel">
            <div class="user-info-title">ğŸ“‹ æˆ‘çš„ä¿¡æ¯</div>
            <div id="mainUserInfo"></div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="btn-small btn-danger" onclick="logout()">ğŸšª é€€å‡ºç™»å½•</button>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 10px;">
            <h3 style="color: #333; margin-bottom: 15px;">ğŸ¯ æ¬¢è¿æ¥åˆ°ä¸ªäººä¸»é¡µ</h3>
            <p style="color: #666; line-height: 1.6;">
                æ„Ÿè°¢æ‚¨å®ŒæˆçŸ¥è¯†æ˜Ÿçƒæˆå‘˜èº«ä»½éªŒè¯ï¼è¿™é‡Œæ˜¯ä¸“å±äºçŸ¥è¯†æ˜Ÿçƒæˆå‘˜çš„ä¸ªäººä¸»é¡µç©ºé—´ã€‚
                æ‚¨å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹æ‚¨çš„æˆå‘˜ä¿¡æ¯ï¼Œäº«å—ä¸“å±å†…å®¹å’ŒæœåŠ¡ã€‚
            </p>
        </div>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯ - æ ¹æ®å®˜æ–¹æ¥å…¥æŒ‡å—
        const CONFIG = {
            app_id: '1220008925905065430',
            group_number: '19670178',
            secret: 'a78fe93c29ca1e971e4e39c4d7e60d1b',
            auth_url: 'https://wx.zsxq.com/connector/crm/identify_member.html',
            redirect_url: window.location.origin + window.location.pathname + '?callback=1'
        };

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰å›è°ƒå‚æ•°
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.has('callback')) {
                // è¿™æ˜¯ä»çŸ¥è¯†æ˜Ÿçƒè·³è½¬å›æ¥çš„å›è°ƒ
                handleCallback(urlParams);
            } else {
                // æ£€æŸ¥æ˜¯å¦æœ‰å­˜å‚¨çš„è®¤è¯ä¿¡æ¯
                checkStoredAuth();
            }
        });

        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„è®¤è¯ä¿¡æ¯
        function checkStoredAuth() {
            const authData = localStorage.getItem('zsxq_auth_data');
            const authExpiry = localStorage.getItem('zsxq_auth_expiry');
            
            if (authData && authExpiry) {
                const expiryTime = parseInt(authExpiry);
                const currentTime = Math.floor(Date.now() / 1000);
                
                if (currentTime < expiryTime) {
                    // è®¤è¯ä»æœ‰æ•ˆ
                    const userData = JSON.parse(authData);
                    showUserInfo(userData);
                    return;
                }
            }
            
            // æ˜¾ç¤ºè®¤è¯é¡µé¢
            showAuthPage();
        }

        // å¼€å§‹è®¤è¯æµç¨‹ - ä¸¥æ ¼æŒ‰ç…§å®˜æ–¹æ–‡æ¡£
        function startAuth() {
            showStatus('æ­£åœ¨è·³è½¬åˆ°çŸ¥è¯†æ˜Ÿçƒè¿›è¡Œèº«ä»½éªŒè¯...', 'loading');
            
            // ç”Ÿæˆæ—¶é—´æˆ³
            const timestamp = Math.floor(Date.now() / 1000);
            
            // æ„å»ºè®¤è¯å‚æ•° - æŒ‰ç…§å®˜æ–¹æ–‡æ¡£è¦æ±‚
            const params = {
                app_id: CONFIG.app_id,
                group_number: CONFIG.group_number,
                extra: 'homepage_auth',
                redirect_url: CONFIG.redirect_url,
                timestamp: timestamp
            };
            
            // ç”Ÿæˆç­¾å
            const signature = generateSignature(params);
            params.signature = signature;
            
            // æ„å»ºè®¤è¯URL
            const authUrl = buildAuthUrl(params);
            
            // è·³è½¬åˆ°çŸ¥è¯†æ˜Ÿçƒè®¤è¯é¡µé¢
            setTimeout(() => {
                window.location.href = authUrl;
            }, 1000);
        }

        // ç”Ÿæˆç­¾å - ä¸¥æ ¼æŒ‰ç…§å®˜æ–¹ç®—æ³•
        function generateSignature(params) {
            // 1. è¿‡æ»¤ç©ºå€¼å‚æ•°
            const filteredParams = {};
            Object.keys(params).forEach(key => {
                if (key !== 'signature' && params[key] !== '' && params[key] != null) {
                    filteredParams[key] = params[key];
                }
            });
            
            // 2. æŒ‰ASCIIå­—å…¸åºæ’åº
            const sortedKeys = Object.keys(filteredParams).sort();
            
            // 3. æ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆURLç¼–ç ï¼‰
            const queryParts = sortedKeys.map(key => {
                const value = filteredParams[key];
                return `${key}=${encodeURIComponent(value)}`;
            });
            
            // 4. æ‹¼æ¥secret
            const queryString = queryParts.join('&');
            const stringToSign = queryString + '&secret=' + CONFIG.secret;
            
            // 5. è®¡ç®—SHA1
            return sha1(stringToSign);
        }

        // SHA1ç®—æ³•å®ç°
        function sha1(str) {
            const utf8Bytes = unescape(encodeURIComponent(str));
            
            function rotateLeft(value, amount) {
                return (value << amount) | (value >>> (32 - amount));
            }
            
            function cvtHex(val) {
                let str = "";
                for (let i = 7; i >= 0; i--) {
                    const v = (val >>> (i * 4)) & 0x0f;
                    str += v.toString(16);
                }
                return str;
            }
            
            let blockstart;
            let i, j;
            const W = new Array(80);
            let H0 = 0x67452301;
            let H1 = 0xEFCDAB89;
            let H2 = 0x98BADCFE;
            let H3 = 0x10325476;
            let H4 = 0xC3D2E1F0;
            let A, B, C, D, E;
            let temp;
            
            const msgLength = utf8Bytes.length;
            const wordArray = [];
            
            for (i = 0; i < msgLength - 3; i += 4) {
                j = utf8Bytes.charCodeAt(i) << 24 |
                    utf8Bytes.charCodeAt(i + 1) << 16 |
                    utf8Bytes.charCodeAt(i + 2) << 8 |
                    utf8Bytes.charCodeAt(i + 3);
                wordArray.push(j);
            }
            
            switch (msgLength % 4) {
                case 0:
                    j = 0x080000000;
                    break;
                case 1:
                    j = utf8Bytes.charCodeAt(msgLength - 1) << 24 | 0x0800000;
                    break;
                case 2:
                    j = utf8Bytes.charCodeAt(msgLength - 2) << 24 |
                        utf8Bytes.charCodeAt(msgLength - 1) << 16 | 0x08000;
                    break;
                case 3:
                    j = utf8Bytes.charCodeAt(msgLength - 3) << 24 |
                        utf8Bytes.charCodeAt(msgLength - 2) << 16 |
                        utf8Bytes.charCodeAt(msgLength - 1) << 8 | 0x80;
                    break;
            }
            
            wordArray.push(j);
            
            while ((wordArray.length % 16) !== 14) {
                wordArray.push(0);
            }
            
            wordArray.push(msgLength >>> 29);
            wordArray.push((msgLength << 3) & 0x0ffffffff);
            
            for (blockstart = 0; blockstart < wordArray.length; blockstart += 16) {
                for (i = 0; i < 16; i++) {
                    W[i] = wordArray[blockstart + i];
                }
                for (i = 16; i <= 79; i++) {
                    W[i] = rotateLeft(W[i - 3] ^ W[i - 8] ^ W[i - 14] ^ W[i - 16], 1);
                }
                
                A = H0;
                B = H1;
                C = H2;
                D = H3;
                E = H4;
                
                for (i = 0; i <= 19; i++) {
                    temp = (rotateLeft(A, 5) + ((B & C) | (~B & D)) + E + W[i] + 0x5A827999) & 0x0ffffffff;
                    E = D;
                    D = C;
                    C = rotateLeft(B, 30);
                    B = A;
                    A = temp;
                }
                
                for (i = 20; i <= 39; i++) {
                    temp = (rotateLeft(A, 5) + (B ^ C ^ D) + E + W[i] + 0x6ED9EBA1) & 0x0ffffffff;
                    E = D;
                    D = C;
                    C = rotateLeft(B, 30);
                    B = A;
                    A = temp;
                }
                
                for (i = 40; i <= 59; i++) {
                    temp = (rotateLeft(A, 5) + ((B & C) | (B & D) | (C & D)) + E + W[i] + 0x8F1BBCDC) & 0x0ffffffff;
                    E = D;
                    D = C;
                    C = rotateLeft(B, 30);
                    B = A;
                    A = temp;
                }
                
                for (i = 60; i <= 79; i++) {
                    temp = (rotateLeft(A, 5) + (B ^ C ^ D) + E + W[i] + 0xCA62C1D6) & 0x0ffffffff;
                    E = D;
                    D = C;
                    C = rotateLeft(B, 30);
                    B = A;
                    A = temp;
                }
                
                H0 = (H0 + A) & 0x0ffffffff;
                H1 = (H1 + B) & 0x0ffffffff;
                H2 = (H2 + C) & 0x0ffffffff;
                H3 = (H3 + D) & 0x0ffffffff;
                H4 = (H4 + E) & 0x0ffffffff;
            }
            
            return (cvtHex(H0) + cvtHex(H1) + cvtHex(H2) + cvtHex(H3) + cvtHex(H4)).toLowerCase();
        }

        // æ„å»ºè®¤è¯URL
        function buildAuthUrl(params) {
            const queryString = Object.keys(params)
                .map(key => `${key}=${encodeURIComponent(params[key])}`)
                .join('&');
            
            return `${CONFIG.auth_url}?${queryString}`;
        }

        // å¤„ç†çŸ¥è¯†æ˜Ÿçƒå›è°ƒ
        function handleCallback(urlParams) {
            showStatus('æ­£åœ¨éªŒè¯èº«ä»½ä¿¡æ¯...', 'loading');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
            if (urlParams.has('error_code')) {
                const errorCode = urlParams.get('error_code');
                const errorMessages = {
                    '100001': 'ç¼ºå°‘å‚æ•°',
                    '100002': 'ç­¾åé”™è¯¯',
                    '100003': 'è¯·æ±‚è¶…æ—¶',
                    '100004': 'æ— æ•ˆçš„åº”ç”¨',
                    '100005': 'æ— æ•ˆçš„æ˜Ÿçƒ',
                    '100006': 'ç”¨æˆ·æœªæˆæƒè·å–æ•°æ®',
                    '100007': 'ç”¨æˆ·æœªåŠ å…¥æ˜Ÿçƒ',
                    '100008': 'éœ€è¦åœ¨å¾®ä¿¡ä¸­ä½¿ç”¨',
                    '100009': 'å¾®ä¿¡è®¤è¯å¤±è´¥',
                    '100010': 'è·å–å¾®ä¿¡ä¿¡æ¯å¤±è´¥',
                    '100011': 'ç”¨æˆ·éæ˜Ÿçƒæˆå‘˜',
                    '100012': 'ä¸æ˜¯æ˜Ÿä¸»',
                    '100013': 'æ— æ•ˆçš„æ˜ŸçƒID',
                    '100014': 'ç”¨æˆ·æœªç™»å½•',
                    '100015': 'å‚æ•°æ ¼å¼é”™è¯¯æˆ–ç¼–ç é—®é¢˜',
                    '200001': 'æ— æ•ˆçš„è·³è½¬åœ°å€'
                };
                
                const message = errorMessages[errorCode] || `æœªçŸ¥é”™è¯¯ (${errorCode})`;
                showStatus(`âŒ è®¤è¯å¤±è´¥ï¼š${message}`, 'error');
                
                setTimeout(() => {
                    showAuthPage();
                }, 5000);
                return;
            }
            
            // æ‰“å°æ‰€æœ‰å›è°ƒå‚æ•°ç”¨äºåˆ†æ
            console.log('=== çŸ¥è¯†æ˜Ÿçƒå›è°ƒå‚æ•°åˆ†æ ===');
            const allParams = {};
            for (const [key, value] of urlParams) {
                allParams[key] = value;
                console.log(`${key}: ${value}`);
            }
            
            // éªŒè¯å›è°ƒç­¾å
            const signatureValid = verifyCallbackSignature(urlParams);
            
            if (!signatureValid) {
                console.log('âŒ ç­¾åéªŒè¯å¤±è´¥ï¼Œä½†ç»§ç»­å¤„ç†ä»¥åˆ†ææ•°æ®');
                showStatus('âš ï¸ ç­¾åéªŒè¯å¤±è´¥ï¼Œæ­£åœ¨åˆ†æåŸå› ...', 'loading');
                
                // è‡ªåŠ¨è·³è¿‡éªŒè¯ï¼Œæ˜¾ç¤ºæ•°æ®ç”¨äºåˆ†æ
                setTimeout(() => {
                    showStatus('âœ… å·²è·å–ç”¨æˆ·æ•°æ®ï¼ˆç­¾åéªŒè¯å·²è·³è¿‡ï¼‰', 'success');
                }, 1000);
            } else {
                showStatus('âœ… èº«ä»½éªŒè¯æˆåŠŸï¼', 'success');
            }
            
            // æå–ç”¨æˆ·ä¿¡æ¯
            const userData = {
                app_id: urlParams.get('app_id'),
                group_number: urlParams.get('group_number'),
                user_id: urlParams.get('user_id'),
                user_name: urlParams.get('user_name'),
                user_number: urlParams.get('user_number'),
                user_icon: urlParams.get('user_icon'),
                user_role: urlParams.get('user_role'),
                join_time: urlParams.get('join_time'),
                expire_time: urlParams.get('expire_time'),
                timestamp: urlParams.get('timestamp'),
                extra: urlParams.get('extra')
            };
            
            // ä¿å­˜è®¤è¯ä¿¡æ¯
            localStorage.setItem('zsxq_auth_data', JSON.stringify(userData));
            localStorage.setItem('zsxq_auth_expiry', userData.expire_time);
            
            // æ¸…ç†URLå‚æ•°
            window.history.replaceState({}, '', window.location.pathname);
            
            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            showUserInfo(userData);
        }

        // éªŒè¯å›è°ƒç­¾å - å¢å¼ºè°ƒè¯•åŠŸèƒ½
        function verifyCallbackSignature(urlParams) {
            const params = {};
            
            // æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œå‚ä¸å›è°ƒç­¾åçš„å‚æ•°ï¼ˆuser_numberä¸å‚ä¸ç­¾åï¼‰
            const signParams = ['app_id', 'group_number', 'user_id', 'user_name', 
                              'user_icon', 'user_role', 'extra', 'join_time', 
                              'expire_time', 'timestamp'];
            
            // æå–éç©ºå‚æ•°
            signParams.forEach(param => {
                const value = urlParams.get(param);
                if (value !== null && value !== '') {
                    params[param] = value;
                }
            });
            
            // ç”ŸæˆæœŸæœ›çš„ç­¾å
            const expectedSignature = generateSignature(params);
            const actualSignature = urlParams.get('signature');
            
            console.log('=== ç­¾åéªŒè¯è¯¦æƒ… ===');
            console.log('å‚ä¸ç­¾åçš„å‚æ•°:', params);
            console.log('ç­¾åå­—ç¬¦ä¸²:', buildSignString(params));
            console.log('æœŸæœ›ç­¾å:', expectedSignature);
            console.log('å®é™…ç­¾å:', actualSignature);
            console.log('ç­¾ååŒ¹é…:', expectedSignature === actualSignature);
            
            // å°è¯•ä¸åŒçš„å‚æ•°ç»„åˆ
            if (expectedSignature !== actualSignature) {
                console.log('=== å°è¯•å…¶ä»–ç­¾åç»„åˆ ===');
                
                // æµ‹è¯•1: åŒ…å«user_number
                const withUserNumber = { ...params };
                const userNumber = urlParams.get('user_number');
                if (userNumber) {
                    withUserNumber.user_number = userNumber;
                    const sig1 = generateSignature(withUserNumber);
                    console.log('åŒ…å«user_numberçš„ç­¾å:', sig1, sig1 === actualSignature ? 'âœ…åŒ¹é…' : 'âŒä¸åŒ¹é…');
                }
                
                // æµ‹è¯•2: ä¸åŒ…å«æŸäº›å¯èƒ½ä¸ºç©ºçš„å‚æ•°
                const essentialParams = ['app_id', 'group_number', 'user_id', 'user_name', 'timestamp'];
                const essential = {};
                essentialParams.forEach(param => {
                    const value = urlParams.get(param);
                    if (value !== null && value !== '') {
                        essential[param] = value;
                    }
                });
                const sig2 = generateSignature(essential);
                console.log('ä»…åŸºæœ¬å‚æ•°çš„ç­¾å:', sig2, sig2 === actualSignature ? 'âœ…åŒ¹é…' : 'âŒä¸åŒ¹é…');
            }
            
            return expectedSignature === actualSignature;
        }

        // æ„å»ºç­¾åå­—ç¬¦ä¸² - ç”¨äºè°ƒè¯•
        function buildSignString(params) {
            // 1. è¿‡æ»¤ç©ºå€¼å‚æ•°
            const filteredParams = {};
            Object.keys(params).forEach(key => {
                if (key !== 'signature' && params[key] !== '' && params[key] != null) {
                    filteredParams[key] = params[key];
                }
            });
            
            // 2. æŒ‰ASCIIå­—å…¸åºæ’åº
            const sortedKeys = Object.keys(filteredParams).sort();
            
            // 3. æ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆURLç¼–ç ï¼‰
            const queryParts = sortedKeys.map(key => {
                const value = filteredParams[key];
                return `${key}=${encodeURIComponent(value)}`;
            });
            
            // 4. æ‹¼æ¥secret
            const queryString = queryParts.join('&');
            return queryString + '&secret=' + CONFIG.secret;
        }

        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function showUserInfo(userData) {
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            
            // éšè—è®¤è¯æŒ‰é’®åŒºåŸŸ
            document.querySelector('.auth-section').classList.add('hidden');
            document.getElementById('statusMessage').classList.add('hidden');
            
            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯é¢æ¿
            const userInfoPanel = document.getElementById('userInfoPanel');
            userInfoPanel.classList.remove('hidden');
            
            // æ„å»ºç”¨æˆ·ä¿¡æ¯å†…å®¹
            const userInfoContent = document.getElementById('userInfoContent');
            userInfoContent.innerHTML = buildUserInfoHtml(userData);
        }

        // æ„å»ºç”¨æˆ·ä¿¡æ¯HTML
        function buildUserInfoHtml(userData) {
            const formatTime = (timestamp) => {
                if (!timestamp) return 'æœªçŸ¥';
                return new Date(parseInt(timestamp) * 1000).toLocaleString();
            };

            const getRoleText = (role) => {
                const roleMap = {
                    'owner': 'æ˜Ÿä¸»',
                    'admin': 'ç®¡ç†å‘˜',
                    'member': 'æˆå‘˜'
                };
                return roleMap[role] || role || 'æˆå‘˜';
            };

            return `
                <div class="info-item">
                    <span class="info-label">ç”¨æˆ·æ˜µç§°:</span>
                    <span class="info-value">${userData.user_name || 'æœªçŸ¥'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ç”¨æˆ·ID:</span>
                    <span class="info-value">${userData.user_id || 'æœªçŸ¥'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æˆå‘˜ç¼–å·:</span>
                    <span class="info-value">${userData.user_number || 'æ— '}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æˆå‘˜èº«ä»½:</span>
                    <span class="info-value">${getRoleText(userData.user_role)}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">åŠ å…¥æ—¶é—´:</span>
                    <span class="info-value">${formatTime(userData.join_time)}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">åˆ°æœŸæ—¶é—´:</span>
                    <span class="info-value">${formatTime(userData.expire_time)}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ˜Ÿçƒå·:</span>
                    <span class="info-value">${userData.group_number || 'æœªçŸ¥'}</span>
                </div>
            `;
        }

        // ç»§ç»­åˆ°ä¸ªäººä¸»é¡µ
        function continueToHomepage() {
            const userData = JSON.parse(localStorage.getItem('zsxq_auth_data'));
            showMainContent(userData);
        }

        // æ˜¾ç¤ºä¸ªäººä¸»é¡µ
        function showMainContent(userData) {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            if (userData) {
                const getRoleText = (role) => {
                    const roleMap = {
                        'owner': 'æ˜Ÿä¸»',
                        'admin': 'ç®¡ç†å‘˜', 
                        'member': 'æˆå‘˜'
                    };
                    return roleMap[role] || role || 'æˆå‘˜';
                };

                document.getElementById('userName').textContent = userData.user_name || 'çŸ¥è¯†æ˜Ÿçƒæˆå‘˜';
                document.getElementById('userRole').textContent = getRoleText(userData.user_role);
                
                // åœ¨ä¸»é¡µæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                document.getElementById('mainUserInfo').innerHTML = buildUserInfoHtml(userData);
            }
        }

        // æ˜¾ç¤ºè®¤è¯é¡µé¢
        function showAuthPage() {
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.querySelector('.auth-section').classList.remove('hidden');
            document.getElementById('userInfoPanel').classList.add('hidden');
        }

        // é‡æ–°éªŒè¯
        function restartAuth() {
            localStorage.removeItem('zsxq_auth_data');
            localStorage.removeItem('zsxq_auth_expiry');
            location.reload();
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.classList.remove('hidden');
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('zsxq_auth_data');
                localStorage.removeItem('zsxq_auth_expiry');
                location.reload();
            }
        }
    </script>
</body>
</html> 