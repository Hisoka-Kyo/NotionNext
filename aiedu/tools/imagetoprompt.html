<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡å€’æ¨æç¤ºè¯å·¥å…· - AIå›¾åƒåˆ†æä¸“ä¸šå¹³å°</title>
    
    <!-- å­—ä½“å’Œå›¾æ ‡ -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-blue: #1e3a8a;
            --primary-blue-light: #3b82f6;
            --secondary-purple: #7c3aed;
            --secondary-purple-light: #a855f7;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.8);
            --bg-glass: rgba(255, 255, 255, 0.1);
            --bg-glass-strong: rgba(255, 255, 255, 0.15);
            
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            
            --border-glass: rgba(255, 255, 255, 0.2);
            --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-card: 0 4px 16px rgba(0, 0, 0, 0.2);
            
            --gradient-primary: linear-gradient(135deg, #1e3a8a, #3b82f6);
            --gradient-secondary: linear-gradient(135deg, #7c3aed, #a855f7);
            --gradient-accent: linear-gradient(135deg, #06b6d4, #0891b2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }

        /* åŠ¨æ€èƒŒæ™¯ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(124, 58, 237, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(6, 182, 212, 0.2) 0%, transparent 50%);
            z-index: -1;
            animation: backgroundFloat 20s ease-in-out infinite;
        }

        @keyframes backgroundFloat {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -30px) rotate(1deg); }
            66% { transform: translate(-20px, 20px) rotate(-1deg); }
        }

        /* ç»ç’ƒæ€å®¹å™¨ */
        .glass-container {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-glass);
            border-radius: 16px;
            box-shadow: var(--shadow-glass);
            transition: all 0.3s ease;
        }

        .glass-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        /* ä¸»å®¹å™¨ */
        .main-container {
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* é¡¶éƒ¨æ ‡é¢˜ */
        .header {
            padding: 30px;
            text-align: center;
            background: var(--gradient-primary);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" patternUnits="userSpaceOnUse" width="10" height="10"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>') repeat;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        /* APIé…ç½®é¢æ¿ */
        .config-panel {
            padding: 25px;
            margin-bottom: 20px;
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .config-header h2 {
            font-size: 1.4rem;
            color: var(--primary-blue-light);
        }

        .toggle-btn {
            background: var(--gradient-accent);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            transform: scale(1.05);
        }

        .config-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .config-content.expanded {
            max-height: 500px;
        }

        .config-section {
            padding: 20px;
            background: var(--bg-glass-strong);
            border-radius: 12px;
            border: 1px solid var(--border-glass);
        }

        .config-section h3 {
            color: var(--secondary-purple-light);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-glass);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        /* ä¸»æ“ä½œåŒºåŸŸ */
        .main-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .upload-section, .result-section {
            padding: 30px;
        }

        .upload-zone {
            border: 2px dashed var(--border-glass);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: var(--bg-glass);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-zone:hover {
            border-color: var(--accent-cyan);
            background: rgba(6, 182, 212, 0.1);
        }

        .upload-zone.drag-over {
            border-color: var(--accent-cyan);
            background: rgba(6, 182, 212, 0.2);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--accent-cyan);
        }

        .preview-container {
            margin: 20px 0;
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: var(--shadow-card);
        }

        .model-selection {
            margin: 20px 0;
        }

        .model-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .model-option {
            padding: 12px;
            background: var(--bg-glass);
            border: 1px solid var(--border-glass);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .model-option:hover {
            border-color: var(--accent-cyan);
        }

        .model-option.selected {
            background: var(--gradient-accent);
            border-color: var(--accent-cyan);
        }

        .action-btn {
            width: 100%;
            padding: 15px;
            background: var(--gradient-primary);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 0;
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .action-btn.secondary {
            background: var(--gradient-secondary);
        }

        .action-btn.secondary:hover:not(:disabled) {
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
        }

        /* ç»“æœå±•ç¤º */
        .result-content {
            background: var(--bg-glass);
            border-radius: 12px;
            padding: 20px;
            min-height: 200px;
            border: 1px solid var(--border-glass);
            white-space: pre-wrap;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .result-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-glass);
        }

        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }

        /* åŠ è½½åŠ¨ç”» */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-glass);
            border-radius: 50%;
            border-top-color: var(--accent-cyan);
            animation: spin 1s ease-in-out infinite;
        }

        /* æ‰“å­—æœºæ•ˆæœ */
        .typing-effect::after {
            content: '|';
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* å¤åˆ¶æŒ‰é’® */
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--gradient-accent);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .result-content:hover .copy-btn {
            opacity: 1;
        }

        /* ç‰ˆæƒä¿¡æ¯ */
        .copyright {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.9rem;
            border-top: 1px solid var(--border-glass);
            margin-top: 40px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-area {
                grid-template-columns: 1fr;
            }
            
            .config-content {
                grid-template-columns: 1fr;
            }
            
            .model-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .main-container {
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="main-container">
        <!-- é¡¶éƒ¨æ ‡é¢˜ -->
        <header class="header glass-container">
            <h1>ğŸ¨ å›¾ç‰‡å€’æ¨æç¤ºè¯å·¥å…·</h1>
            <p>ä¸“ä¸šAIå›¾åƒåˆ†æå¹³å° - æ™ºèƒ½æç¤ºè¯ç”Ÿæˆä¸ä¼˜åŒ–</p>
        </header>

        <!-- APIé…ç½®é¢æ¿ -->
        <section class="config-panel glass-container">
            <div class="config-header">
                <h2>ğŸ”§ APIé…ç½®ä¸­å¿ƒ</h2>
                <button class="toggle-btn" onclick="toggleConfig()">
                    <span id="toggleText">å±•å¼€é…ç½®</span>
                </button>
            </div>
            
            <div class="config-content" id="configContent">
                <!-- DeepSeeké…ç½® -->
                <div class="config-section">
                    <h3>ğŸ¤– DeepSeek APIé…ç½®</h3>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="password" id="deepseekApiKey" placeholder="è¾“å…¥DeepSeek API Key">
                    </div>
                    <div class="form-group">
                        <label>ä¼˜åŒ–æ¨¡å‹</label>
                        <select id="deepseekModel">
                            <option value="deepseek-chat">DeepSeek Chat</option>
                            <option value="deepseek-reasoner">DeepSeek Reasoner</option>
                        </select>
                    </div>
                    <button class="action-btn" onclick="testDeepSeekAPI()">æµ‹è¯•è¿æ¥</button>
                </div>

                <!-- é€šä¹‰åƒé—®é…ç½® -->
                <div class="config-section">
                    <h3>ğŸ§  é€šä¹‰åƒé—®APIé…ç½®</h3>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="password" id="qwenApiKey" placeholder="è¾“å…¥é€šä¹‰åƒé—®API Key">
                    </div>
                    <div class="form-group">
                        <label>è§†è§‰æ¨¡å‹</label>
                        <select id="qwenVisionModel">
                            <option value="qwen-vl-plus">Qwen-VL-Plus</option>
                            <option value="qwen-vl-max">Qwen-VL-Max</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ä¼˜åŒ–æ¨¡å‹</label>
                        <select id="qwenOptModel">
                            <option value="qwen-turbo">Qwen Turbo</option>
                            <option value="qwen-plus">Qwen Plus</option>
                        </select>
                    </div>
                    <button class="action-btn" onclick="testQwenAPI()">æµ‹è¯•è¿æ¥</button>
                </div>
            </div>
        </section>

        <!-- ä¸»æ“ä½œåŒºåŸŸ -->
        <div class="main-area">
            <!-- å›¾ç‰‡ä¸Šä¼ å’Œåˆ†æ -->
            <section class="upload-section glass-container">
                <h2 style="color: var(--primary-blue-light); margin-bottom: 20px;">ğŸ“¸ å›¾ç‰‡åˆ†æ</h2>
                
                <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">ğŸ“</div>
                    <div>ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 10px;">
                        æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤§ 10MB
                    </div>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                
                <!-- å›¾ç‰‡é¢„è§ˆ -->
                <div class="preview-container" id="previewContainer" style="display: none;">
                    <img class="preview-image" id="previewImage" alt="é¢„è§ˆå›¾ç‰‡">
                </div>

                <!-- æ¨¡å‹é€‰æ‹© -->
                <div class="model-selection">
                    <h3 style="color: var(--secondary-purple-light); margin-bottom: 15px;">é€‰æ‹©åˆ†ææ¨¡å‹</h3>
                    <div class="model-grid">
                        <div class="model-option selected" data-model="qwen-vl-plus">
                            Qwen-VL-Plus<br>
                            <small>é«˜æ•ˆåˆ†æ</small>
                        </div>
                        <div class="model-option" data-model="qwen-vl-max">
                            Qwen-VL-Max<br>
                            <small>ä¸“ä¸šåˆ†æ</small>
                        </div>
                    </div>
                </div>

                <!-- åˆ†ææŒ‰é’® -->
                <button class="action-btn" id="analyzeBtn" onclick="analyzeImage()">
                    ğŸ” å¼€å§‹åˆ†æå›¾ç‰‡
                </button>
            </section>

            <!-- ç»“æœå±•ç¤ºå’Œä¼˜åŒ– -->
            <section class="result-section glass-container">
                <h2 style="color: var(--primary-blue-light); margin-bottom: 20px;">ğŸ“ æç¤ºè¯ç»“æœ</h2>
                
                <!-- ç»“æœæ ‡ç­¾é¡µ -->
                <div class="result-tabs">
                    <button class="tab-btn active" onclick="switchTab('original')">åŸå§‹æç¤ºè¯</button>
                    <button class="tab-btn" onclick="switchTab('optimized')">ä¼˜åŒ–æç¤ºè¯</button>
                </div>

                <!-- åŸå§‹æç¤ºè¯ -->
                <div id="originalResult" class="result-content" style="position: relative;">
                    <div style="text-align: center; color: var(--text-muted); padding: 40px 0;">
                        ä¸Šä¼ å›¾ç‰‡å¹¶ç‚¹å‡»åˆ†ææŒ‰é’®å¼€å§‹ç”Ÿæˆæç¤ºè¯
                    </div>
                    <button class="copy-btn" onclick="copyResult('original')" style="display: none;">å¤åˆ¶</button>
                </div>

                <!-- ä¼˜åŒ–æç¤ºè¯ -->
                <div id="optimizedResult" class="result-content" style="position: relative; display: none;">
                    <div style="text-align: center; color: var(--text-muted); padding: 40px 0;">
                        å…ˆç”ŸæˆåŸå§‹æç¤ºè¯ï¼Œç„¶åè¿›è¡Œä¼˜åŒ–
                    </div>
                    <button class="copy-btn" onclick="copyResult('optimized')" style="display: none;">å¤åˆ¶</button>
                </div>

                <!-- ä¼˜åŒ–é€‰é¡¹ -->
                <div style="margin-top: 20px;">
                    <h3 style="color: var(--secondary-purple-light); margin-bottom: 15px;">é€‰æ‹©ä¼˜åŒ–æ¨¡å‹</h3>
                    <div class="model-grid">
                        <div class="model-option selected" data-optimize="deepseek">
                            DeepSeek<br>
                            <small>é€»è¾‘ä¼˜åŒ–</small>
                        </div>
                        <div class="model-option" data-optimize="qwen">
                            é€šä¹‰åƒé—®<br>
                            <small>åˆ›æ„ä¼˜åŒ–</small>
                        </div>
                    </div>
                </div>

                <!-- ä¼˜åŒ–æŒ‰é’® -->
                <button class="action-btn secondary" id="optimizeBtn" onclick="optimizePrompt()">
                    âœ¨ ä¼˜åŒ–æç¤ºè¯
                </button>
            </section>
        </div>

        <!-- ç‰ˆæƒä¿¡æ¯ -->
        <footer class="copyright">
            æœ¬é¡µé¢ç”±å…¬ä¼—å·å…ˆè§ä¿¡æ¯å¼€å‘æä¾›ï¼Œç¦æ­¢å•†ç”¨
        </footer>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentImage = null;
        let originalPrompt = '';
        let selectedVisionModel = 'qwen-vl-plus';
        let selectedOptimizeModel = 'deepseek';
        let configExpanded = false;

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            setupEventListeners();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ‹–æ‹½ä¸Šä¼ 
            const uploadZone = document.getElementById('uploadZone');
            
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('drag-over');
            });

            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            // æ¨¡å‹é€‰æ‹©
            document.querySelectorAll('.model-option[data-model]').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.model-option[data-model]').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedVisionModel = option.dataset.model;
                });
            });

            document.querySelectorAll('.model-option[data-optimize]').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.model-option[data-optimize]').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedOptimizeModel = option.dataset.optimize;
                });
            });
        }

        // é…ç½®é¢æ¿åˆ‡æ¢
        function toggleConfig() {
            const content = document.getElementById('configContent');
            const toggleText = document.getElementById('toggleText');
            
            configExpanded = !configExpanded;
            
            if (configExpanded) {
                content.classList.add('expanded');
                toggleText.textContent = 'æ”¶èµ·é…ç½®';
            } else {
                content.classList.remove('expanded');
                toggleText.textContent = 'å±•å¼€é…ç½®';
            }
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            const deepseekKey = localStorage.getItem('deepseek_api_key');
            const qwenKey = localStorage.getItem('qwen_api_key');
            
            if (deepseekKey) {
                document.getElementById('deepseekApiKey').value = deepseekKey;
            }
            if (qwenKey) {
                document.getElementById('qwenApiKey').value = qwenKey;
            }
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            const deepseekKey = document.getElementById('deepseekApiKey').value.trim();
            const qwenKey = document.getElementById('qwenApiKey').value.trim();
            
            if (deepseekKey) {
                localStorage.setItem('deepseek_api_key', deepseekKey);
            }
            if (qwenKey) {
                localStorage.setItem('qwen_api_key', qwenKey);
            }
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // æ–‡ä»¶å¤„ç†
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MBï¼');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImage = e.target.result;
                showPreview(currentImage);
            };
            reader.readAsDataURL(file);
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        function showPreview(imageSrc) {
            document.getElementById('previewContainer').style.display = 'block';
            document.getElementById('previewImage').src = imageSrc;
        }

        // åˆ†æå›¾ç‰‡
        async function analyzeImage() {
            if (!currentImage) {
                alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
                return;
            }

            const qwenKey = document.getElementById('qwenApiKey').value.trim();
            if (!qwenKey) {
                alert('è¯·å…ˆé…ç½®é€šä¹‰åƒé—®API Keyï¼');
                toggleConfig();
                return;
            }

            saveConfig();

            const analyzeBtn = document.getElementById('analyzeBtn');
            const resultDiv = document.getElementById('originalResult');
            
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<span class="loading-spinner"></span> åˆ†æä¸­...';
            
            resultDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary);">
                    <span class="loading-spinner"></span>
                    <span>AIæ­£åœ¨åˆ†æå›¾ç‰‡ï¼Œè¯·ç¨å€™...</span>
                </div>
            `;

            try {
                const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${qwenKey}`
                    },
                    body: JSON.stringify({
                        model: selectedVisionModel,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image_url',
                                    image_url: { url: currentImage }
                                },
                                {
                                    type: 'text',
                                    text: 'è¯·è¯¦ç»†åˆ†æè¿™å¼ å›¾ç‰‡ï¼Œå¹¶ç”Ÿæˆä¸“ä¸šçš„ä¸­æ–‡AIç»˜ç”»æç¤ºè¯ã€‚è¦æ±‚ï¼š1.æè¿°ä¸»ä½“å¯¹è±¡çš„å¤–è§‚ç‰¹å¾ 2.æè¿°åœºæ™¯ç¯å¢ƒå’ŒèƒŒæ™¯ 3.æè¿°è‰ºæœ¯é£æ ¼å’ŒæŠ€æ³• 4.æè¿°å…‰å½±å’Œè‰²å½©æ•ˆæœ 5.æè¿°æ„å›¾å’Œè§†è§’ã€‚è¯·ç”¨é€—å·åˆ†éš”å„ä¸ªå…³é”®è¯ï¼Œå½¢æˆå®Œæ•´çš„æç¤ºè¯ã€‚'
                                }
                            ]
                        }],
                        stream: true,
                        max_tokens: 2000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error('åˆ†æè¯·æ±‚å¤±è´¥');
                }

                let result = '';
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                resultDiv.innerHTML = '<div class="typing-effect"></div>';
                const typingElement = resultDiv.querySelector('.typing-effect');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data:') && line !== 'data: [DONE]') {
                            try {
                                const data = JSON.parse(line.slice(5));
                                const content = data.choices[0]?.delta?.content || '';
                                if (content) {
                                    result += content;
                                    typingElement.textContent = result;
                                }
                            } catch (e) {
                                console.error('è§£æå“åº”å‡ºé”™:', e);
                            }
                        }
                    }
                }

                originalPrompt = result;
                resultDiv.innerHTML = `
                    <div>${result}</div>
                    <button class="copy-btn" onclick="copyResult('original')">å¤åˆ¶</button>
                `;

            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                resultDiv.innerHTML = `
                    <div style="color: #ef4444; text-align: center; padding: 20px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">âŒ</div>
                        <div>åˆ†æå¤±è´¥: ${error.message}</div>
                    </div>
                `;
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = 'ğŸ” å¼€å§‹åˆ†æå›¾ç‰‡';
            }
        }

        // ä¼˜åŒ–æç¤ºè¯
        async function optimizePrompt() {
            if (!originalPrompt) {
                alert('è¯·å…ˆç”ŸæˆåŸå§‹æç¤ºè¯ï¼');
                return;
            }

            let apiKey, model, apiUrl;
            
            if (selectedOptimizeModel === 'deepseek') {
                apiKey = document.getElementById('deepseekApiKey').value.trim();
                model = document.getElementById('deepseekModel').value;
                apiUrl = 'https://api.deepseek.com/chat/completions';
            } else {
                apiKey = document.getElementById('qwenApiKey').value.trim();
                model = document.getElementById('qwenOptModel').value;
                apiUrl = 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
            }

            if (!apiKey) {
                alert(`è¯·å…ˆé…ç½®${selectedOptimizeModel === 'deepseek' ? 'DeepSeek' : 'é€šä¹‰åƒé—®'}API Keyï¼`);
                toggleConfig();
                return;
            }

            saveConfig();

            const optimizeBtn = document.getElementById('optimizeBtn');
            const resultDiv = document.getElementById('optimizedResult');
            
            // åˆ‡æ¢åˆ°ä¼˜åŒ–æ ‡ç­¾é¡µ
            switchTab('optimized');
            
            optimizeBtn.disabled = true;
            optimizeBtn.innerHTML = '<span class="loading-spinner"></span> ä¼˜åŒ–ä¸­...';
            
            resultDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary);">
                    <span class="loading-spinner"></span>
                    <span>AIæ­£åœ¨ä¼˜åŒ–æç¤ºè¯ï¼Œè¯·ç¨å€™...</span>
                </div>
            `;

            try {
                const headers = {
                    'Content-Type': 'application/json'
                };

                if (selectedOptimizeModel === 'deepseek') {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                } else {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                }

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        model: model,
                        messages: [{
                            role: 'user',
                            content: `è¯·ä¼˜åŒ–ä»¥ä¸‹AIç»˜ç”»æç¤ºè¯ï¼Œä½¿å…¶æ›´åŠ ä¸“ä¸šã€å‡†ç¡®å’Œå¯Œæœ‰è¡¨ç°åŠ›ã€‚è¦æ±‚ï¼š
1. ä¿æŒåŸæœ‰æ ¸å¿ƒå†…å®¹çš„å®Œæ•´æ€§
2. å¢å¼ºæè¿°çš„ä¸“ä¸šæ€§å’Œå‡†ç¡®æ€§
3. ä¼˜åŒ–å…³é”®è¯çš„æ’åºå’Œç»„åˆ
4. å¢åŠ å¿…è¦çš„è‰ºæœ¯æŠ€æ³•å’Œé£æ ¼æè¿°
5. ç¡®ä¿æç¤ºè¯é€»è¾‘æ¸…æ™°ã€å±‚æ¬¡åˆ†æ˜

åŸå§‹æç¤ºè¯ï¼š
${originalPrompt}

è¯·ç›´æ¥è¾“å‡ºä¼˜åŒ–åçš„æç¤ºè¯ï¼Œç”¨é€—å·åˆ†éš”ï¼š`
                        }],
                        stream: true,
                        max_tokens: 2000,
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    throw new Error('ä¼˜åŒ–è¯·æ±‚å¤±è´¥');
                }

                let result = '';
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                resultDiv.innerHTML = '<div class="typing-effect"></div>';
                const typingElement = resultDiv.querySelector('.typing-effect');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data:') && line !== 'data: [DONE]') {
                            try {
                                const data = JSON.parse(line.slice(5));
                                const content = data.choices[0]?.delta?.content || '';
                                if (content) {
                                    result += content;
                                    typingElement.textContent = result;
                                }
                            } catch (e) {
                                console.error('è§£æå“åº”å‡ºé”™:', e);
                            }
                        }
                    }
                }

                resultDiv.innerHTML = `
                    <div>${result}</div>
                    <button class="copy-btn" onclick="copyResult('optimized')">å¤åˆ¶</button>
                `;

            } catch (error) {
                console.error('ä¼˜åŒ–å¤±è´¥:', error);
                resultDiv.innerHTML = `
                    <div style="color: #ef4444; text-align: center; padding: 20px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">âŒ</div>
                        <div>ä¼˜åŒ–å¤±è´¥: ${error.message}</div>
                    </div>
                `;
            } finally {
                optimizeBtn.disabled = false;
                optimizeBtn.innerHTML = 'âœ¨ ä¼˜åŒ–æç¤ºè¯';
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
            
            // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
            document.getElementById('originalResult').style.display = tab === 'original' ? 'block' : 'none';
            document.getElementById('optimizedResult').style.display = tab === 'optimized' ? 'block' : 'none';
        }

        // å¤åˆ¶ç»“æœ
        function copyResult(type) {
            const resultDiv = document.getElementById(type + 'Result');
            const text = resultDiv.querySelector('div').textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = resultDiv.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'å·²å¤åˆ¶';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 1000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶');
            });
        }

        // æµ‹è¯•DeepSeek API
        async function testDeepSeekAPI() {
            const apiKey = document.getElementById('deepseekApiKey').value.trim();
            if (!apiKey) {
                alert('è¯·è¾“å…¥DeepSeek API Keyï¼');
                return;
            }

            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [{ role: 'user', content: 'æµ‹è¯•è¿æ¥' }],
                        max_tokens: 10
                    })
                });

                if (response.ok) {
                    alert('DeepSeek APIè¿æ¥æˆåŠŸï¼');
                } else {
                    throw new Error('è¿æ¥å¤±è´¥');
                }
            } catch (error) {
                alert('DeepSeek APIè¿æ¥å¤±è´¥: ' + error.message);
            }
        }

        // æµ‹è¯•é€šä¹‰åƒé—®API
        async function testQwenAPI() {
            const apiKey = document.getElementById('qwenApiKey').value.trim();
            if (!apiKey) {
                alert('è¯·è¾“å…¥é€šä¹‰åƒé—®API Keyï¼');
                return;
            }

            try {
                const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'qwen-plus',
                        messages: [{ role: 'user', content: 'æµ‹è¯•è¿æ¥' }],
                        max_tokens: 10
                    })
                });

                if (response.ok) {
                    alert('é€šä¹‰åƒé—®APIè¿æ¥æˆåŠŸï¼');
                } else {
                    throw new Error('è¿æ¥å¤±è´¥');
                }
            } catch (error) {
                alert('é€šä¹‰åƒé—®APIè¿æ¥å¤±è´¥: ' + error.message);
            }
        }
    </script>
</body>
</html>
